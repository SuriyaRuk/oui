(window["visTypeVega_bundle_jsonpfunction"]=window["visTypeVega_bundle_jsonpfunction"]||[]).push([[3],{108:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__.d(__webpack_exports__,"VegaMapView",(function(){return vega_map_view_VegaMapView}));var external_osdSharedDeps_OsdI18n_=__webpack_require__(2);var vega=__webpack_require__(55);var vega_base_view=__webpack_require__(65);var public_=__webpack_require__(51);class vega_map_layer_VegaMapLayer extends public_["OpenSearchDashboardsMapLayer"]{constructor(spec,options,leaflet){super();this._attribution=options.attribution;delete options.attribution;this._leafletLayer=leaflet.vega(spec,options)}getVegaView(){return this._leafletLayer._view}getVegaSpec(){return this._leafletLayer._spec}}var services=__webpack_require__(3);class vega_map_view_VegaMapView extends vega_base_view["a"]{constructor(opts){super(opts)}async _initViewCustomizations(){const mapConfig=this._parser.mapConfig;let baseMapOpts;let limitMinZ=0;let limitMaxZ=25;if(mapConfig.mapStyle!==false){const tmsServices=await this._serviceSettings.getTMSServices();if(!this._$container)return;const emsTileLayerId=Object(services["b"])();const mapStyle=mapConfig.mapStyle==="default"?emsTileLayerId.bright:mapConfig.mapStyle;const isDarkMode=Object(services["g"])().get("theme:darkMode");baseMapOpts=tmsServices.find(s=>s.id===mapStyle);baseMapOpts={...baseMapOpts,...await this._serviceSettings.getAttributesForTMSLayer(baseMapOpts,true,isDarkMode),showRegionDeniedWarning:Object(services["f"])()};if(!baseMapOpts){this.onWarn(external_osdSharedDeps_OsdI18n_["i18n"].translate("visTypeVega.mapView.mapStyleNotFoundWarningMessage",{defaultMessage:"{mapStyleParam} was not found",values:{mapStyleParam:'"mapStyle": '.concat(JSON.stringify(mapStyle))}}))}else{limitMinZ=baseMapOpts.minZoom;limitMaxZ=baseMapOpts.maxZoom}}const validate=(name,value,dflt,min,max)=>{if(value===undefined){value=dflt}else if(value<min){this.onWarn(external_osdSharedDeps_OsdI18n_["i18n"].translate("visTypeVega.mapView.resettingPropertyToMinValueWarningMessage",{defaultMessage:"Resetting {name} to {min}",values:{name:'"'.concat(name,'"'),min:min}}));value=min}else if(value>max){this.onWarn(external_osdSharedDeps_OsdI18n_["i18n"].translate("visTypeVega.mapView.resettingPropertyToMaxValueWarningMessage",{defaultMessage:"Resetting {name} to {max}",values:{name:'"'.concat(name,'"'),max:max}}));value=max}return value};let minZoom=validate("minZoom",mapConfig.minZoom,limitMinZ,limitMinZ,limitMaxZ);let maxZoom=validate("maxZoom",mapConfig.maxZoom,limitMaxZ,limitMinZ,limitMaxZ);if(minZoom>maxZoom){this.onWarn(external_osdSharedDeps_OsdI18n_["i18n"].translate("visTypeVega.mapView.minZoomAndMaxZoomHaveBeenSwappedWarningMessage",{defaultMessage:"{minZoomPropertyName} and {maxZoomPropertyName} have been swapped",values:{minZoomPropertyName:'"minZoom"',maxZoomPropertyName:'"maxZoom"'}}));[minZoom,maxZoom]=[maxZoom,minZoom]}const zoom=validate("zoom",mapConfig.zoom,2,minZoom,maxZoom);const modules=await Object(public_["lazyLoadMapsLegacyModules"])();this._opensearchDashboardsMap=new modules.OpenSearchDashboardsMap(this._$container.get(0),{zoom:zoom,minZoom:minZoom,maxZoom:maxZoom,center:[mapConfig.latitude,mapConfig.longitude],zoomControl:mapConfig.zoomControl,scrollWheelZoom:mapConfig.scrollWheelZoom});if(baseMapOpts){this._opensearchDashboardsMap.setBaseLayer({baseLayerType:"tms",options:baseMapOpts})}const vegaMapLayer=new vega_map_layer_VegaMapLayer(this._parser.spec,{vega:vega["a"],bindingsContainer:this._$controls.get(0),delayRepaint:mapConfig.delayRepaint,viewConfig:this._vegaViewConfig,parseConfig:null,parseOptions:this._vegaViewOptions,onWarning:this.onWarn.bind(this),onError:this.onError.bind(this)},modules.L);this._opensearchDashboardsMap.addLayer(vegaMapLayer);this._addDestroyHandler(()=>{this._opensearchDashboardsMap.removeLayer(vegaMapLayer);if(baseMapOpts){this._opensearchDashboardsMap.setBaseLayer(null)}this._opensearchDashboardsMap.destroy()});const vegaView=vegaMapLayer.getVegaView();await this.setView(vegaView);this.setDebugValues(vegaView,this._parser.spec,this._parser.vlspec)}}},55:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"c",(function(){return vegaLite}));var vega_lite_next_src__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(74);var vega_build_es5_vega__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(60);var vega_build_es5_vega__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(vega_build_es5_vega__WEBPACK_IMPORTED_MODULE_1__);__webpack_require__.d(__webpack_exports__,"a",(function(){return vega_build_es5_vega__WEBPACK_IMPORTED_MODULE_1__}));var vega_interpreter_build_vega_interpreter_module__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(61);__webpack_require__.d(__webpack_exports__,"b",(function(){return vega_interpreter_build_vega_interpreter_module__WEBPACK_IMPORTED_MODULE_2__["a"]}));const vegaLite={compile:vega_lite_next_src__WEBPACK_IMPORTED_MODULE_0__["a"],version:vega_lite_next_src__WEBPACK_IMPORTED_MODULE_0__["b"]}},62:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return utils_Utils}));var json_stringify_pretty_compact=__webpack_require__(18);var json_stringify_pretty_compact_default=__webpack_require__.n(json_stringify_pretty_compact);const validate_object_hasOwnProperty=(obj,property)=>Object.prototype.hasOwnProperty.call(obj,property);const isObject=obj=>typeof obj==="object"&&obj!==null;function validateObject(obj){if(!isObject(obj)){return}const stack=[{value:obj,previousKey:null}];const seen=new WeakSet([obj]);while(stack.length>0){const{value:value,previousKey:previousKey}=stack.pop();if(!isObject(value)){continue}if(validate_object_hasOwnProperty(value,"__proto__")){throw new Error("'__proto__' is an invalid key")}if(validate_object_hasOwnProperty(value,"prototype")&&previousKey==="constructor"){throw new Error("'constructor.prototype' is an invalid key")}const entries=Object.entries(value);for(let i=entries.length-1;i>=0;--i){const[key,childValue]=entries[i];if(isObject(childValue)){if(seen.has(childValue)){throw new Error("circular reference detected")}seen.add(childValue)}stack.push({value:childValue,previousKey:key})}}}class utils_Utils{static formatWarningToStr(){let value=arguments.length<=0?undefined:arguments[0];if(arguments.length>=2){try{if(typeof(arguments.length<=1?undefined:arguments[1])==="string"){value+="\n".concat(arguments.length<=1?undefined:arguments[1])}else{value+="\n"+json_stringify_pretty_compact_default()(arguments.length<=1?undefined:arguments[1],{maxLength:70})}}catch(err){}}return value}static formatErrorToStr(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}let error=args[0];if(!error){error="ERR"}else if(error instanceof Error){error=error.message}return utils_Utils.formatWarningToStr(error,...Array.from(args).slice(1))}static handleNonStringIndex(index){return typeof index==="string"?index:undefined}static handleInvalidQuery(query){if(utils_Utils.isObject(query)&&!utils_Utils.checkForFunctionProperty(query)){validateObject(query);return JSON.parse(JSON.stringify(query))}return null}static isObject(object){return!!(object&&typeof object==="object"&&!Array.isArray(object))}static checkForFunctionProperty(object){let result=false;Object.values(object).forEach(value=>{result=typeof value==="function"?true:utils_Utils.isObject(value)&&utils_Utils.checkForFunctionProperty(value)});return result}static handleInvalidDate(date){if(typeof date==="number"){return!isNaN(date)?date:null}else if(date instanceof Date||typeof date==="string"){return date}return null}}},65:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"b",(function(){return bypassExternalUrlCheck}));__webpack_require__.d(__webpack_exports__,"a",(function(){return vega_base_view_VegaBaseView}));var external_osdSharedDeps_Jquery_=__webpack_require__(50);var external_osdSharedDeps_Jquery_default=__webpack_require__.n(external_osdSharedDeps_Jquery_);var external_osdSharedDeps_Moment_=__webpack_require__(49);var external_osdSharedDeps_Moment_default=__webpack_require__.n(external_osdSharedDeps_Moment_);var target=__webpack_require__(72);var target_default=__webpack_require__.n(target);var vega=__webpack_require__(55);var utils=__webpack_require__(62);var external_osdSharedDeps_ElasticEui_=__webpack_require__(1);var external_osdSharedDeps_OsdI18n_=__webpack_require__(2);var vega_tooltip=__webpack_require__(73);var external_osdSharedDeps_Lodash_=__webpack_require__(6);var external_osdSharedDeps_Lodash_default=__webpack_require__.n(external_osdSharedDeps_Lodash_);const tooltipId="vega-opensearch-dashboards-tooltip";function createRect(left,top,width,height){return{left:left,top:top,width:width,height:height,x:left,y:top,right:left+width,bottom:top+height}}class vega_tooltip_TooltipHandler{constructor(container,view,opts){this.container=container;this.position=opts.position;this.padding=opts.padding;this.centerOnMark=opts.centerOnMark;view.tooltip(this.handler.bind(this))}handler(view,event,item,value){this.hideTooltip();if(value==null||value===""){return}const el=document.createElement("div");el.setAttribute("id",tooltipId);["vgaVis__tooltip","euiToolTipPopover","euiToolTip","euiToolTip--".concat(this.position)].forEach(className=>{el.classList.add(className)});el.innerHTML=Object(vega_tooltip["formatValue"])(value,external_osdSharedDeps_Lodash_default.a.escape,2);document.body.appendChild(el);let anchorBounds;if(item.bounds.width()>this.centerOnMark||item.bounds.height()>this.centerOnMark){anchorBounds=createRect(event.clientX,event.clientY,0,0)}else{const containerBox=this.container.getBoundingClientRect();anchorBounds=createRect(containerBox.left+view._origin[0]+item.bounds.x1,containerBox.top+view._origin[1]+item.bounds.y1,item.bounds.width(),item.bounds.height())}const pos=Object(external_osdSharedDeps_ElasticEui_["calculatePopoverPosition"])(anchorBounds,el.getBoundingClientRect(),this.position,this.padding);el.setAttribute("style","top: ".concat(pos.top,"px; left: ").concat(pos.left,"px"))}hideTooltip(){const el=document.getElementById(tooltipId);if(el)el.remove()}}var public_=__webpack_require__(11);var services=__webpack_require__(3);var extract_index_pattern=__webpack_require__(19);vega["a"].scheme("euiPaletteColorBlind",Object(external_osdSharedDeps_ElasticEui_["euiPaletteColorBlind"])());const vegaFunctions={opensearchDashboardsAddFilter:"addFilterHandler",opensearchDashboardsRemoveFilter:"removeFilterHandler",opensearchDashboardsRemoveAllFilters:"removeAllFiltersHandler",opensearchDashboardsSetTimeFilter:"setTimeFilterHandler",opensearchDashboardsVisEventTriggered:"triggerExternalActionHandler"};for(const funcName of Object.keys(vegaFunctions)){if(!vega["a"].expressionFunction(funcName)){vega["a"].expressionFunction(funcName,(function handlerFwd(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}const view=this.context.dataflow;view.runAfter(()=>view._opensearchDashboardsView.vegaFunctionsHandler(funcName,...args))}))}}const bypassToken=Symbol();function bypassExternalUrlCheck(url){return{url:url,bypassToken:bypassToken}}class vega_base_view_VegaBaseView{constructor(opts){this._$parentEl=external_osdSharedDeps_Jquery_default()(opts.parentEl);this._parser=opts.vegaParser;this._serviceSettings=opts.serviceSettings;this._filterManager=opts.filterManager;this._applyFilter=opts.applyFilter;this._triggerExternalAction=opts.externalAction;this._timefilter=opts.timefilter;this._view=null;this._vegaViewConfig=null;this._vegaViewOptions=null;this._$messages=null;this._destroyHandlers=[];this._initialized=false;this._enableExternalUrls=Object(services["c"])()}async init(){if(this._initialized)throw new Error;this._initialized=true;try{this._$parentEl.empty().addClass("vgaVis").css("flex-direction",this._parser.containerDir);for(const warn of this._parser.warnings){this._addMessage("warn",warn)}if(this._parser.error){this._addMessage("err",this._parser.error);return}this._$container=external_osdSharedDeps_Jquery_default()('<div class="vgaVis__view">').css("height","100%").appendTo(this._$parentEl);this._$controls=external_osdSharedDeps_Jquery_default()('<div class="vgaVis__controls vgaVis__controls--'.concat(this._parser.controlsDir,'">')).appendTo(this._$parentEl);this._addDestroyHandler(()=>{if(this._$container){this._$container.remove();this._$container=null}if(this._$controls){this._$controls.remove();this._$controls=null}if(this._$messages){this._$messages.remove();this._$messages=null}if(this._view){this._view.finalize()}this._view=null});this._vegaViewConfig=this.createViewConfig();this._vegaViewOptions={ast:true};await this._initViewCustomizations()}catch(err){this.onError(err)}}async findIndex(index){const{indexPatterns:indexPatterns}=Object(services["a"])();let idxObj;if(index){[idxObj]=await indexPatterns.find(index);if(!idxObj){throw new Error(external_osdSharedDeps_OsdI18n_["i18n"].translate("visTypeVega.vegaParser.baseView.indexNotFoundErrorMessage",{defaultMessage:"Index {index} not found",values:{index:'"'.concat(index,'"')}}))}}else{[idxObj]=await Object(extract_index_pattern["a"])(this._parser.isVegaLite?this._parser.vlspec:this._parser.spec);if(!idxObj){const defaultIdx=await indexPatterns.getDefault();if(defaultIdx){idxObj=defaultIdx}else{throw new Error(external_osdSharedDeps_OsdI18n_["i18n"].translate("visTypeVega.vegaParser.baseView.unableToFindDefaultIndexErrorMessage",{defaultMessage:"Unable to find default index"}))}}}return idxObj.id}createViewConfig(){const config={logLevel:vega["a"].Warn,renderer:this._parser.renderer,expr:vega["b"]};const loader=vega["a"].loader();const originalSanitize=loader.sanitize.bind(loader);loader.sanitize=(uri,options)=>{if(uri.bypassToken===bypassToken){uri=uri.url}else if(!this._enableExternalUrls){throw new Error(external_osdSharedDeps_OsdI18n_["i18n"].translate("visTypeVega.vegaParser.baseView.externalUrlsAreNotEnabledErrorMessage",{defaultMessage:"External URLs are not enabled. Add   {enableExternalUrls}   to {opensearchDashboardsConfigFileName}",values:{enableExternalUrls:"vis_type_vega.enableExternalUrls: true",opensearchDashboardsConfigFileName:"opensearch_dashboards.yml"}}))}return originalSanitize(uri,options)};config.loader=loader;return config}onError(){this._addMessage("err",utils["a"].formatErrorToStr(...arguments))}onWarn(){if(!this._parser||!this._parser.hideWarnings){this._addMessage("warn",utils["a"].formatWarningToStr(...arguments))}}_addMessage(type,text){if(!this._$messages){this._$messages=external_osdSharedDeps_Jquery_default()('<ul class="vgaVis__messages">').appendTo(this._$parentEl)}this._$messages.append(external_osdSharedDeps_Jquery_default()('<li class="vgaVis__message vgaVis__message--'.concat(type,'">')).append(external_osdSharedDeps_Jquery_default()('<pre class="vgaVis__messageCode">').text(text)))}resize(){if(this._parser.useResize&&this._view&&this.updateVegaSize(this._view)){return this._view.runAsync()}}updateVegaSize(view){const heightExtraPadding=6;const width=Math.max(0,this._$container.width());const height=Math.max(0,this._$container.height())-heightExtraPadding;if(view.width()!==width||view.height()!==height){view.width(width).height(height);return true}return false}addPointInTimeEventPadding(view){const eventVisHeight=100;const height=Math.max(0,this._$container.height())-eventVisHeight;if(view._signals.concat_0_height!==undefined){view._signals.concat_0_height.value=height}}setView(view){if(this._view===view)return;if(this._view){this._view.finalize()}this._view=view;if(view){view._opensearchDashboardsView=this;if(this._parser.tooltips){const tthandler=new vega_tooltip_TooltipHandler(this._$container[0],view,this._parser.tooltips);this._addDestroyHandler(()=>tthandler.hideTooltip())}return view.runAsync()}}async vegaFunctionsHandler(funcName){try{const handlerFunc=vegaFunctions[funcName];if(!handlerFunc||!this[handlerFunc]){throw new Error(external_osdSharedDeps_OsdI18n_["i18n"].translate("visTypeVega.vegaParser.baseView.functionIsNotDefinedForGraphErrorMessage",{defaultMessage:"{funcName} is not defined for this graph",values:{funcName:"".concat(funcName,"()")}}))}for(var _len2=arguments.length,args=new Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){args[_key2-1]=arguments[_key2]}await this[handlerFunc](...args)}catch(err){this.onError(err)}}async addFilterHandler(query,index,alias){const indexId=await this.findIndex(utils["a"].handleNonStringIndex(index));const filter=public_["opensearchFilters"].buildQueryFilter(utils["a"].handleInvalidQuery(query),indexId,alias);this._applyFilter({filters:[filter]})}triggerExternalActionHandler(event,datum){this._triggerExternalAction({event:event,item:datum})}async removeFilterHandler(query,index){const indexId=await this.findIndex(utils["a"].handleNonStringIndex(index));const filterToRemove=public_["opensearchFilters"].buildQueryFilter(utils["a"].handleInvalidQuery(query),indexId);const currentFilters=this._filterManager.getFilters();const existingFilter=currentFilters.find(filter=>public_["opensearchFilters"].compareFilters(filter,filterToRemove));if(!existingFilter)return;try{this._filterManager.removeFilter(existingFilter)}catch(err){this.onError(err)}}removeAllFiltersHandler(){this._filterManager.removeAll()}setTimeFilterHandler(start,end){const{from:from,to:to,mode:mode}=vega_base_view_VegaBaseView._parseTimeRange(utils["a"].handleInvalidDate(start),utils["a"].handleInvalidDate(end));this._applyFilter({timeFieldName:"*",filters:[{range:{"*":{mode:mode,gte:from,lte:to}}}]})}static _parseTimeRange(start,end){const absStart=external_osdSharedDeps_Moment_default()(start);const absEnd=external_osdSharedDeps_Moment_default()(end);const isValidAbsStart=absStart.isValid();const isValidAbsEnd=absEnd.isValid();let mode="absolute";let from;let to;let reverse;if(isValidAbsStart&&isValidAbsEnd){from=absStart;to=absEnd;reverse=absStart.isAfter(absEnd)}else{const startDate=target_default.a.parse(start);const endDate=target_default.a.parse(end);if(!startDate||!endDate||!startDate.isValid()||!endDate.isValid()){throw new Error(external_osdSharedDeps_OsdI18n_["i18n"].translate("visTypeVega.vegaParser.baseView.timeValuesTypeErrorMessage",{defaultMessage:"Error setting time filter: both time values must be either relative or absolute dates. {start}, {end}",values:{start:"start=".concat(JSON.stringify(start)),end:"end=".concat(JSON.stringify(end))}}))}reverse=startDate.isAfter(endDate);if(isValidAbsStart||isValidAbsEnd){from=startDate;to=endDate}else{mode="relative";from=start;to=end}}if(reverse){[from,to]=[to,from]}return{from:from,to:to,mode:mode}}setDebugValues(view,spec,vlspec){var _this$_parser$searchA,_this$_parser$searchA2;(_this$_parser$searchA=this._parser.searchAPI.inspectorAdapters)===null||_this$_parser$searchA===void 0?void 0:(_this$_parser$searchA2=_this$_parser$searchA.vega)===null||_this$_parser$searchA2===void 0?void 0:_this$_parser$searchA2.bindInspectValues({view:view,spec:vlspec||spec});if(window){if(window.VEGA_DEBUG===undefined&&console){console.log("%cWelcome to OpenSearch Dashboards Vega Plugin!","font-size: 16px; font-weight: bold;");console.log("You can access the Vega view with VEGA_DEBUG. "+"Learn more at https://vega.github.io/vega/docs/api/debugging/.")}const debugObj={};window.VEGA_DEBUG=debugObj;window.VEGA_DEBUG.VEGA_VERSION=vega["a"].version;window.VEGA_DEBUG.VEGA_LITE_VERSION=vega["c"].version;window.VEGA_DEBUG.view=view;window.VEGA_DEBUG.vega_spec=spec;window.VEGA_DEBUG.vegalite_spec=vlspec;this._addDestroyHandler(()=>{if(debugObj===window.VEGA_DEBUG){window.VEGA_DEBUG=null}})}}destroy(){if(this._destroyHandlers){this._ongoingDestroy=Promise.all(this._destroyHandlers.map(v=>v()));this._destroyHandlers=null}return this._ongoingDestroy}_addDestroyHandler(handler){if(this._destroyHandlers){this._destroyHandlers.push(handler)}else{handler()}}}}}]);